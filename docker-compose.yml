version: "3.9"

services:
  ros2-sim:
    build:
      context: .
      dockerfile: Dockerfile.sim
    container_name: ros2-sim
    user: "${UID:-1000}:${GID:-1000}"
    network_mode: host
    ipc: host
    environment:
      ROS_DOMAIN_ID: "0"
      LANG: "C.UTF-8"
      LC_ALL: "C.UTF-8"
      DISPLAY: ${DISPLAY}
    volumes:
      - ./ros2_ws:/root/ros2_ws
      - ./bags:/root/bags
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
    stdin_open: true
    tty: true
    command: >
      bash -lc "
        source /opt/ros/foxy/setup.bash &&
        source /root/ros2_ws/install/setup.bash || true &&
        exec bash
      "

  rosbridge:
    build:
      context: .
      dockerfile: Dockerfile.sim
    container_name: rosbridge
    depends_on:
      - ros2-sim
    user: root
    network_mode: host
    environment:
      ROS_DOMAIN_ID: "0"
      LANG: "C.UTF-8"
      LC_ALL: "C.UTF-8"
    # Wichtig: KEIN ./ros2_ws hier mounten, nur bags wenn du willst
    volumes:
      - ./bags:/root/bags
    command: >
      bash -lc "
        source /opt/ros/foxy/setup.bash &&
        ros2 launch rosbridge_server rosbridge_websocket_launch.xml
          port:=8765 address:=0.0.0.0
          use_compression:=false max_message_size:=104857600 fragment_size:=65536
      "

  # Optional — nur Burak/Jetson benutzt dieses Service
  realsense-hw:
    image: myrepo/myapp:jetson-fix-2025-10-27
    container_name: realsense-hw
    profiles: ["hw"]
    privileged: true
    user: root
    network_mode: host
    ipc: host
    environment:
      ROS_DOMAIN_ID: "0"
      LANG: "C.UTF-8"
      LC_ALL: "C.UTF-8"
    devices:
      - /dev/bus/usb:/dev/bus/usb
    volumes:
      # Dein Jetson-Workspace (über das Symlink ./ros2_ws -> /home/jetson/ros2_ws)
      - ./ros2_ws:/root/ros2_ws
      - ./bags:/root/bags
    command: >
      bash -lc '
        # 1) ROS2-Basis Umgebung
        if [ -f /opt/ros/foxy/install/setup.bash ]; then
          echo "Sourcing /opt/ros/foxy/install/setup.bash";
          source /opt/ros/foxy/install/setup.bash;
        elif [ -f /opt/ros/foxy/setup.bash ]; then
          echo "Sourcing /opt/ros/foxy/setup.bash";
          source /opt/ros/foxy/setup.bash;
        else
          echo "WARN: Kein ROS foxy setup.bash gefunden";
        fi

        # 2) Dein Workspace-Overlay mit realsense2_camera
        if [ -f /root/ros2_ws/install/setup.bash ]; then
          echo "Sourcing /root/ros2_ws/install/setup.bash";
          source /root/ros2_ws/install/setup.bash;
        else
          echo "WARN: /root/ros2_ws/install/setup.bash fehlt – realsense2_camera evtl. nicht gebaut";
        fi

        # 3) Jetzt erst realsense starten
        exec ros2 launch realsense2_camera dual_realsense.launch.py enable_pointcloud:=true
      '