version: "3.9"

services:
  # -----------------------------
  # 1) SIM-ENTWICKLUNG (x86_64)
  # -----------------------------
  ros2-sim:
    build:
      context: .
      dockerfile: Dockerfile.sim
    container_name: ros2-sim
    environment:
      ROS_DOMAIN_ID: "0"
      RMW_IMPLEMENTATION: "rmw_cyclonedds_cpp"
      LANG: "C.UTF-8"
      LC_ALL: "C.UTF-8"
      DISPLAY: ${DISPLAY}               # Linux: GUI-Tools im Container (optional)
    volumes:
      - ./ros2_ws:/root/ros2_ws            # euer Workspace (Host<->Container)
      - ./bags:/root/bags                  # optionale Rosbags
      - /tmp/.X11-unix:/tmp/.X11-unix:rw   # Linux X11-Forwarding (optional); Webots runs natively on host
    network_mode: host
    ipc: host
    command: >
      bash -lc "
        source /opt/ros/foxy/setup.bash &&
        cd /root/ros2_ws &&
        colcon build --symlink-install || true &&
        bash
      "

  # Optionaler rosbridge (für Foxglove, macOS/Windows oder externe Tools)
  rosbridge:
    build:
      context: .
      dockerfile: Dockerfile.sim
    container_name: rosbridge
    depends_on:
      - ros2-sim
    environment:
      ROS_DOMAIN_ID: "0"
      RMW_IMPLEMENTATION: "rmw_cyclonedds_cpp"
      LANG: "C.UTF-8"
      LC_ALL: "C.UTF-8"
    volumes:
      - ./ros2_ws:/root/ros2_ws            # euer Workspace (Host<->Container)
      - ./bags:/root/bags                  # optionale Rosbags
    # Unter Linux könnt ihr auch host network nutzen:
    # network_mode: host
    ports:
      - "8765:8765"                         # Foxglove/rosbridge WebSocket-Port
    command: >
      bash -lc "
        source /opt/ros/foxy/setup.bash &&
        source /root/ros2_ws/install/setup.bash || true &&
        ros2 launch rosbridge_server rosbridge_websocket_launch.xml
          port:=8765 address:=0.0.0.0
          use_compression:=false max_message_size:=104857600 fragment_size:=65536
      "