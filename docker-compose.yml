version: "3.9"

services:
  ros2-sim:
    build:
      context: .
      dockerfile: Dockerfile.sim
    container_name: ros2-sim
    user: "${UID:-1000}:${GID:-1000}"
    network_mode: host
    ipc: host
    environment:
      ROS_DOMAIN_ID: "0"
      LANG: "C.UTF-8"
      LC_ALL: "C.UTF-8"
      DISPLAY: ${DISPLAY}
    volumes:
      - ./ros2_ws:/root/ros2_ws
      - ./bags:/root/bags
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
    stdin_open: true
    tty: true
    command: >
      bash -lc "
        source /opt/ros/foxy/setup.bash &&
        source /root/ros2_ws/install/setup.bash || true &&
        exec bash
      "

  rosbridge:
    build:
      context: .
      dockerfile: Dockerfile.sim
    container_name: rosbridge
    depends_on:
      - ros2-sim
    # user: root ist optional – schadet aber nicht, kannst du gerne setzen:
    user: root
    network_mode: host
    environment:
      ROS_DOMAIN_ID: "0"
      LANG: "C.UTF-8"
      LC_ALL: "C.UTF-8"
    volumes:
      - ./ros2_ws:/root/ros2_ws
      - ./bags:/root/bags
    ports:
      - "8765:8765"
    command: >
      bash -lc "
        source /opt/ros/foxy/setup.bash &&
        source /root/ros2_ws/install/setup.bash || true &&
        ros2 launch rosbridge_server rosbridge_websocket_launch.xml
          port:=8765 address:=0.0.0.0
          use_compression:=false max_message_size:=104857600 fragment_size:=65536
      "

  # Optional — nur Burak/Jetson benutzt dieses Service
  realsense-hw:
    image: myrepo/myapp:jetson-fix-2025-10-27
    container_name: realsense-hw
    profiles: ["hw"]
    privileged: true
    network_mode: host
    ipc: host
    environment:
      ROS_DOMAIN_ID: "0"
      LANG: "C.UTF-8"
      LC_ALL: "C.UTF-8"
    devices:
      - /dev/bus/usb:/dev/bus/usb
    # WICHTIG: ros2_ws NICHT mounten, damit das im Image baked Workspace bleibt!
    # Optional kannst du z.B. nur bags mounten, wenn du aufzeichnen willst:
    volumes:
      - ./bags:/root/bags
    command: >
      bash -lc "
        source /opt/ros/foxy/setup.bash &&
        source /root/ros2_ws/install/setup.bash || true &&
        ros2 launch realsense2_camera dual_realsense.launch.py enable_pointcloud:=true
      "