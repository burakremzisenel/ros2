services:
  ros2-sim:
    build:
      context: .
      dockerfile: Dockerfile.sim
    container_name: ros2-sim
    user: "${UID:-1000}:${GID:-1000}"
    environment:
      ROS_DOMAIN_ID: "0"
      # RMW_IMPLEMENTATION weg oder auf rmw_fastrtps_cpp setzen:
      # RMW_IMPLEMENTATION: "rmw_fastrtps_cpp"
      LANG: "C.UTF-8"
      LC_ALL: "C.UTF-8"
      DISPLAY: ${DISPLAY}
    volumes:
      - ./ros2_ws:/root/ros2_ws
      - ./bags:/root/bags
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
    network_mode: host
    ipc: host
    stdin_open: true       # interaktiv (wie dein run.sh)
    tty: true
    command: >
      bash -lc "
        source /opt/ros/foxy/setup.bash &&
        source /root/ros2_ws/install/setup.bash || true &&
        exec bash
      "

  rosbridge:
    build:
      context: .
      dockerfile: Dockerfile.sim
    container_name: rosbridge
    depends_on:
      - ros2-sim
    user: root
    environment:
      ROS_DOMAIN_ID: "0"
      # wie oben: entweder weglassen oder FastRTPS:
      # RMW_IMPLEMENTATION: "rmw_fastrtps_cpp"
      LANG: "C.UTF-8"
      LC_ALL: "C.UTF-8"
    volumes:
      - ./ros2_ws:/root/ros2_ws
      - ./bags:/root/bags
    ports:
      - "8765:8765"
    command: >
      bash -lc "
        source /opt/ros/foxy/setup.bash &&
        source /root/ros2_ws/install/setup.bash || true &&
        ros2 launch rosbridge_server rosbridge_websocket_launch.xml
          port:=8765 address:=0.0.0.0
          use_compression:=false max_message_size:=104857600 fragment_size:=65536
      "
    healthcheck:
      test: ["CMD", "bash", "-c", "exec 3<>/dev/tcp/127.0.0.1/8765 || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 5

  # Nur fÃ¼r Burak / Jetson: RealSense-Hardware-Container (bionic-basiertes Image)
  realsense-hw:
    image: myrepo/myapp:jetson-fix-2025-10-27   # dein vorhandenes Jetson-Image
    container_name: realsense-hw
    profiles: ["hw"]                            # NUR starten, wenn Profil 'hw' aktiv ist
    privileged: true
    network_mode: host
    ipc: host
    environment:
      ROS_DOMAIN_ID: "0"
      LANG: "C.UTF-8"
      LC_ALL: "C.UTF-8"
    devices:
      - /dev/bus/usb:/dev/bus/usb              # Zugriff auf T265 + D435i
    volumes:
      - ./ros2_ws:/root/ros2_ws                # gleicher Workspace wie im sim-Container
    command: >
      bash -lc "
        source /opt/ros/foxy/setup.bash &&
        source /root/ros2_ws/install/setup.bash || true &&
        ros2 launch realsense2_camera dual_realsense.launch.py enable_pointcloud:=true
      "